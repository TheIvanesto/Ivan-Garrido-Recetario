<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Recetario - Autocontenido</title>
  <link rel="stylesheet" href="recetario.css">
</head>
<body>
  <div class="app" id="app">
    <header class="nav">
      <div class="brand">
        <strong class="logo">Recetario</strong>
        <span class="tag">Recetas caseras ¬∑ sin dependencias externas</span>
      </div>
      <nav aria-label="principal" class="main-nav">
        <a href="#/catalogo">Cat√°logo</a>
        <a href="#/planner">Planner</a>
        <a href="#/lista-compra">Lista</a>
        <a href="#/nuevo">A√±adir</a>
      </nav>
      <div class="controls">
        <div class="searchbar"><input id="search" placeholder="Buscar recetas, ingredientes..." aria-label="Buscar recetas" /></div>
        <label style="display:flex;align-items:center;gap:6px;font-size:0.9rem;margin-left:6px"><input type="checkbox" id="externalToggle"> Incluir recetas externas</label>
        <button id="favoritesBtn" class="icon-btn" aria-pressed="false" title="Mostrar favoritos">‚ù§ <span id="favCount">0</span></button>
        <button id="themeToggle" class="icon-btn" title="Alternar tema">üåì</button>
      </div>
    </header>

    <main id="view"></main>

    <div id="aria-live" class="visually-hidden" aria-live="polite"></div>

    <footer>
      Recetario ‚Äî Versi√≥n local. Para prox. pasos: build & servir para soporte offline completo (Service Worker).
    </footer>
  </div>

  <script>
  // Data: 12 recetas (inline para archivo autocontenido)
  const RECIPES = [
  {"id":"r1","title":"Tostadas mediterr√°neas","servings":2,"prepTime":10,"cookTime":5,"difficulty":"f√°cil","cuisine":"Mediterr√°nea","tags":["vegetariano","r√°pido"],"ingredients":[{"name":"pan r√∫stico","quantity":4,"unit":"unit"},{"name":"tomate","quantity":2,"unit":"unit"},{"name":"aceite de oliva","quantity":2,"unit":"tbsp"}],"steps":[{"text":"Tostar el pan.","time":2},{"text":"Frotar tomate y ali√±ar.","time":0}],"rating":4.5,"votes":120,"author":"A. Cocina","description":"Tostadas sencillas con tomate y aceite."},
  {"id":"r2","title":"Curry de garbanzos","servings":4,"prepTime":15,"cookTime":30,"difficulty":"medio","cuisine":"India","tags":["vegano","sin-gluten"],"ingredients":[{"name":"garbanzos cocidos","quantity":400,"unit":"g"},{"name":"leche de coco","quantity":200,"unit":"ml"},{"name":"cebolla","quantity":1,"unit":"unit"}],"steps":[{"text":"Pochar cebolla y especias.","time":5},{"text":"A√±adir garbanzos y leche de coco, cocinar.","time":20}],"rating":4.7,"votes":254,"author":"M. Vegan","description":"Curry cremoso y arom√°tico."},
  {"id":"r3","title":"Brownie cl√°sico","servings":8,"prepTime":15,"cookTime":25,"difficulty":"f√°cil","cuisine":"Internacional","tags":["postre"],"ingredients":[{"name":"chocolate negro","quantity":200,"unit":"g"},{"name":"mantequilla","quantity":150,"unit":"g"},{"name":"az√∫car","quantity":200,"unit":"g"},{"name":"huevos","quantity":3,"unit":"unit"}],"steps":[{"text":"Derretir chocolate y mantequilla.","time":5},{"text":"Mezclar y hornear.","time":25}],"rating":4.8,"votes":1021,"author":"La Repostera","description":"Brownie h√∫medo con corteza crujiente."},
  {"id":"r4","title":"Avena overnight con frutas","servings":2,"prepTime":10,"cookTime":0,"difficulty":"f√°cil","cuisine":"Internacional","tags":["vegano","desayuno"],"ingredients":[{"name":"copos de avena","quantity":100,"unit":"g"},{"name":"leche vegetal","quantity":300,"unit":"ml"},{"name":"frutas mixtas","quantity":150,"unit":"g"}],"steps":[{"text":"Mezclar y reposar en fr√≠o toda la noche.","time":0}],"rating":4.2,"votes":64,"author":"Saludable","description":"R√°pido y nutritivo para desayunos."},
  {"id":"r5","title":"Ensalada de quinoa y aguacate","servings":3,"prepTime":15,"cookTime":15,"difficulty":"f√°cil","cuisine":"Mediterr√°nea","tags":["vegetariano","sin-gluten"],"ingredients":[{"name":"quinoa","quantity":200,"unit":"g"},{"name":"aguacate","quantity":2,"unit":"unit"}],"steps":[{"text":"Cocer quinoa y mezclar con resto de ingredientes.","time":10}],"rating":4.4,"votes":88,"author":"Huerta","description":"Fresca y saciante."},
  {"id":"r6","title":"Sopa de lentejas","servings":4,"prepTime":15,"cookTime":40,"difficulty":"medio","cuisine":"Internacional","tags":["vegano"],"ingredients":[{"name":"lentejas","quantity":300,"unit":"g"},{"name":"zanahoria","quantity":2,"unit":"unit"}],"steps":[{"text":"Cocer y sazonar.","time":30}],"rating":4.3,"votes":140,"author":"Cocinero","description":"Sopa reconfortante."},
  {"id":"r7","title":"Pasta al pesto","servings":2,"prepTime":10,"cookTime":10,"difficulty":"f√°cil","cuisine":"Italiana","tags":["vegetariano"],"ingredients":[{"name":"pasta","quantity":200,"unit":"g"},{"name":"pesto","quantity":80,"unit":"g"}],"steps":[{"text":"Cocinar pasta y mezclar con pesto.","time":10}],"rating":4.6,"votes":512,"author":"Nonna","description":"Cl√°sico italiano."},
  {"id":"r8","title":"Tacos de pescado","servings":4,"prepTime":20,"cookTime":10,"difficulty":"medio","cuisine":"Mexicana","tags":["mariscos"],"ingredients":[{"name":"filete de pescado","quantity":400,"unit":"g"},{"name":"tortillas","quantity":8,"unit":"unit"}],"steps":[{"text":"Cocinar y montar tacos.","time":10}],"rating":4.1,"votes":201,"author":"Mar","description":"Tacos frescos y sabrosos."},
  {"id":"r9","title":"Pollo al horno con hierbas","servings":4,"prepTime":15,"cookTime":60,"difficulty":"medio","cuisine":"Mediterr√°nea","tags":["principal"],"ingredients":[{"name":"pollo entero","quantity":1,"unit":"unit"},{"name":"patatas","quantity":500,"unit":"g"}],"steps":[{"text":"Hornear hasta dorar.","time":60}],"rating":4.5,"votes":330,"author":"Asador","description":"Plato familiar."},
  {"id":"r10","title":"Crema de calabaza","servings":4,"prepTime":15,"cookTime":30,"difficulty":"f√°cil","cuisine":"Internacional","tags":["vegano","sopa"],"ingredients":[{"name":"calabaza","quantity":700,"unit":"g"},{"name":"caldo vegetal","quantity":500,"unit":"ml"}],"steps":[{"text":"Cocer y triturar.","time":20}],"rating":4.0,"votes":76,"author":"SopaChef","description":"Suave y oto√±al."},
  {"id":"r11","title":"Ensalada C√©sar","servings":2,"prepTime":10,"cookTime":0,"difficulty":"f√°cil","cuisine":"Internacional","tags":["ensalada"],"ingredients":[{"name":"lechuga","quantity":1,"unit":"unit"},{"name":"pollo a la plancha","quantity":200,"unit":"g"}],"steps":[{"text":"Montar ensalada.","time":0}],"rating":4.2,"votes":89,"author":"ChefSalud","description":"Cl√°sica con aderezo cremoso."},
  {"id":"r12","title":"Pancakes esponjosos","servings":4,"prepTime":15,"cookTime":10,"difficulty":"f√°cil","cuisine":"Internacional","tags":["desayuno","postre"],"ingredients":[{"name":"harina","quantity":250,"unit":"g"},{"name":"leche","quantity":300,"unit":"ml"},{"name":"huevo","quantity":2,"unit":"unit"}],"steps":[{"text":"Mezclar y cocinar en sart√©n.","time":8}],"rating":4.7,"votes":412,"author":"Desayunos","description":"Perfectos para brunch."}
  ];

  // A√±adimos recetas internacionales adicionales con tips
  RECIPES.push(
    { id: 'r13', title: 'Sushi variado', servings: 2, prepTime: 40, cookTime: 0, difficulty: 'medio', cuisine: 'Japonesa', tags: ['pescado','fresco'], ingredients: [{name:'arroz para sushi',quantity:300,unit:'g'},{name:'vinagre de arroz',quantity:30,unit:'ml'},{name:'salm√≥n',quantity:150,unit:'g'}], steps:[{text:'Preparar arroz y montar nigiris/rolls',time:0}], rating:4.8, votes:210, author:'SushiMaster', description:'Nigiris y makis variados.', tips: ['Usa arroz de buena calidad y deja reposar 10 min','Mant√©n el pescado fr√≠o hasta el montaje'], pairings: ['Sake fr√≠o','T√© verde'] },
    { id: 'r14', title: 'Mapo Tofu', servings: 3, prepTime: 15, cookTime: 20, difficulty: 'medio', cuisine: 'China', tags: ['picante','principal'], ingredients: [{name:'tofu firme',quantity:400,unit:'g'},{name:'pasta de chile',quantity:2,unit:'tbsp'},{name:'carne picada',quantity:150,unit:'g'}], steps:[{text:'Cocinar picantes y tofu',time:20}], rating:4.5, votes:98, author:'Szechuan', description:'Picante y sabroso.', tips: ['Escoge tofu firme y corta en cubos grandes','A√±ade aceite de chile al final para brillo'], pairings: ['Riesling','T√© de jazm√≠n'] },
    { id: 'r15', title: 'Coq au Vin', servings: 4, prepTime: 25, cookTime: 90, difficulty: 'medio', cuisine: 'Francesa', tags: ['guiso'], ingredients: [{name:'pollo',quantity:1,unit:'unit'},{name:'vino tinto',quantity:500,unit:'ml'},{name:'champi√±ones',quantity:200,unit:'g'}], steps:[{text:'Cocer a fuego lento en vino',time:90}], rating:4.7, votes:123, author:'Chef de France', description:'Cl√°sico guiso franc√©s.', tips: ['Desglasar bien y cocer lento para textura tierna','Usa buen vino tinto para el guiso'], pairings: ['Bordeaux','Pinot Noir'] },
    { id: 'r16', title: 'Paella mixta', servings: 4, prepTime: 30, cookTime: 40, difficulty: 'medio', cuisine: 'Espa√±ola', tags: ['arroz','mariscos'], ingredients: [{name:'arroz',quantity:400,unit:'g'},{name:'azafr√°n',quantity:0.5,unit:'g'},{name:'mejillones',quantity:200,unit:'g'}], steps:[{text:'Cocinar arroz con caldo y mariscos',time:40}], rating:4.9, votes:512, author:'Valenciano', description:'Paella tradicional.', tips: ['No remover mucho el arroz para obtener socarrat','Usa caldo casero para mejor sabor'], pairings: ['Rioja','Cava'] },
    { id: 'r17', title: 'Moussaka', servings: 4, prepTime: 30, cookTime: 60, difficulty: 'medio', cuisine: 'Griega', tags: ['horneado'], ingredients: [{name:'berenjena',quantity:2,unit:'unit'},{name:'carne picada',quantity:400,unit:'g'},{name:'bechamel',quantity:300,unit:'ml'}], steps:[{text:'Montar capas y hornear',time:60}], rating:4.4, votes:87, author:'Greco', description:'Cazuela de berenjenas y carne.', tips: ['Salar berenjenas y dejarlas reposar para eliminar amargor','Dejar reposar 15 min antes de servir'], pairings: ['Assyrtiko','Vino tinto ligero'] },
    { id: 'r18', title: 'BBQ Ribs', servings: 4, prepTime: 20, cookTime: 180, difficulty: 'medio', cuisine: 'Americana', tags: ['barbacoa'], ingredients: [{name:'costillas',quantity:1,unit:'unit'},{name:'salsa BBQ',quantity:200,unit:'ml'}], steps:[{text:'Cocer lentamente al horno o smoker',time:180}], rating:4.6, votes:322, author:'Pitmaster', description:'Costillas ahumadas y glaseadas.', tips: ['Cocer a baja temperatura por largo tiempo','Aplicar salsa al final para caramelizar'], pairings: ['Zinfandel','IPA'] },
    { id: 'r19', title: 'Empanadas salte√±as', servings: 6, prepTime: 40, cookTime: 25, difficulty: 'medio', cuisine: 'Argentina', tags: ['horno'], ingredients: [{name:'masa para empanadas',quantity:12,unit:'unit'},{name:'carne',quantity:400,unit:'g'}], steps:[{text:'Rellenar y hornear',time:25}], rating:4.5, votes:204, author:'Gaucho', description:'Empanadas tradicionales.', tips: ['Relleno jugoso pero no l√≠quido','Cierra bien los bordes para evitar fuga'], pairings: ['Malbec','Cerveza rubia'] },
    { id: 'r20', title: 'Feijoada', servings: 6, prepTime: 30, cookTime: 180, difficulty: 'medio', cuisine: 'Brasilera', tags: ['guiso'], ingredients: [{name:'frijoles negros',quantity:500,unit:'g'},{name:'carnes variadas',quantity:800,unit:'g'}], steps:[{text:'Hervir frijoles con carnes',time:180}], rating:4.6, votes:190, author:'Bahia', description:'Guiso de frijoles y carnes.', tips: ['Remojar frijoles la noche anterior','Servir con farofa y naranja'], pairings: ['Caipirinha','Cerveza lager'] },
    { id: 'r21', title: 'Tajine de cordero', servings: 4, prepTime: 25, cookTime: 120, difficulty: 'medio', cuisine: 'Marroqu√≠', tags: ['guiso','especiado'], ingredients: [{name:'cordero',quantity:800,unit:'g'},{name:'ciruelas',quantity:150,unit:'g'}], steps:[{text:'Cocer lentamente con especias y frutas',time:120}], rating:4.7, votes:76, author:'Marruecos', description:'Tajine arom√°tico con fruta.', tips: ['Usar especias frescas y cocer lento','Equilibrar dulce y salado con lim√≥n encurtido'], pairings: ['T√© de menta','Vino tinto ligero'] },
    { id: 'r22', title: 'Thai Green Curry', servings: 3, prepTime: 20, cookTime: 25, difficulty: 'medio', cuisine: 'Tailandesa', tags: ['picante','curry'], ingredients: [{name:'pasta de curry verde',quantity:50,unit:'g'},{name:'leche de coco',quantity:400,unit:'ml'},{name:'pollo',quantity:300,unit:'g'}], steps:[{text:'Cocinar pasta y a√±adir leche de coco/verduras',time:25}], rating:4.6, votes:145, author:'Bangkok', description:'Curry verde con aroma fresco.', tips: ['Ajusta picante con chiles verdes','A√±ade albahaca tailandesa al final'], pairings: ['Riesling dulce','T√© helado tailand√©s'] }
  );

  // small utils
  function q(sel, el=document){ return el.querySelector(sel); }
  function debounce(fn, wait=300){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),wait); }; }
  function formatFraction(v){ if (Math.abs(v - Math.round(v)) < 1e-6) return String(Math.round(v)); const whole = Math.floor(v); const frac = v - whole; const maxDen=8; let best={n:0,d:1,diff:1}; for(let d=1; d<=maxDen; d++){ const n=Math.round(frac*d); const diff=Math.abs(frac - n/d); if(diff<best.diff){best={n,d,diff};}} if(best.n===0) return String(whole); const g=(a,b)=>b?g(b,a%b):a; const gg=g(best.n,best.d); const n=best.n/gg; const d=best.d/gg; return (whole?whole+' ':'')+n+'/'+d; }
  function convertDisplay(qty, unit) {
    if (!unit) return { value: qty, unit: '' };
    // Normalize grams / kilograms
    if (unit === 'g' || unit === 'kg') {
      const grams = unit === 'kg' ? qty * 1000 : qty;
      if (Math.abs(grams) >= 1000) {
        // show as kg with two decimals
        return { value: Math.round((grams / 1000) * 100) / 100, unit: 'kg' };
      }
      return { value: Math.round(grams), unit: 'g' };
    }
    // Normalize milliliters / liters
    if (unit === 'ml' || unit === 'l') {
      const ml = unit === 'l' ? qty * 1000 : qty;
      if (Math.abs(ml) >= 1000) {
        return { value: Math.round((ml / 1000) * 100) / 100, unit: 'l' };
      }
      return { value: Math.round(ml), unit: 'ml' };
    }
    // Default: return as-is
    return { value: qty, unit: unit };
  }

  // whether to render remote images (user preference stored in localStorage)
  function shouldShowExternalImages(){ try{ return localStorage.getItem('showExtImages') === '1'; }catch(e){ return false; } }

  // favorites & theme helpers
  let showOnlyFavorites = false;
  function getFavorites(){ try{return JSON.parse(localStorage.getItem('favorites')||'[]')}catch(e){return []} }
  function saveFavorites(arr){ localStorage.setItem('favorites', JSON.stringify(arr)); }
  function isFavorite(id){ return getFavorites().includes(id); }
  function toggleFavorite(id){ const f=getFavorites(); const i=f.indexOf(id); if(i===-1) f.push(id); else f.splice(i,1); saveFavorites(f); updateFavCount(); }
  function updateFavCount(){ const el=document.getElementById('favCount'); if(el) el.textContent = String(getFavorites().length || 0); }

  function applyTheme(t){ if(t==='dark') document.documentElement.setAttribute('data-theme','dark'); else document.documentElement.removeAttribute('data-theme'); localStorage.setItem('theme',t); }

  // External API: TheMealDB (no API key required). We'll cache search results in localStorage for 24h.
  const TM_CACHE_TTL = 24 * 60 * 60 * 1000; // 24h
  let lastExternalError = null; // store last error message for UI diagnostics
  async function fetchExternalMeals(query){
    if(!query) return [];
    const qnorm = String(query).trim().toLowerCase();
    const key = 'tm_cache_' + qnorm;
    // try cache
    try{
      const cached = JSON.parse(localStorage.getItem(key) || 'null');
      if(cached && (Date.now() - cached.ts) < TM_CACHE_TTL){ return cached.data; }
    }catch(e){/* ignore malformed cache */}

    // fetch with timeout
  const controller = new AbortController(); const timeout = setTimeout(()=>controller.abort(), 15000); // 15s timeout for slow networks
    try{
      const url = `https://www.themealdb.com/api/json/v1/1/search.php?s=${encodeURIComponent(query)}`;
      const res = await fetch(url, { signal: controller.signal });
      clearTimeout(timeout);
      if(!res.ok) return [];
      const j = await res.json();
      const meals = j.meals || [];
      // map to internal simplified shape and mark source
      const mapped = meals.map(m=>({
        id: 'tm_' + m.idMeal,
        source: 'tm',
        sourceId: String(m.idMeal),
        title: m.strMeal || 'Sin t√≠tulo',
        cuisine: m.strArea || '',
        difficulty: 'medio',
        prepTime: 0,
        cookTime: 0,
        description: m.strInstructions ? m.strInstructions.substring(0,200) : '',
        image: m.strMealThumb || '',
        ingredients: (()=>{ const list=[]; for(let i=1;i<=20;i++){ const n=m['strIngredient'+i]; const q=m['strMeasure'+i]; if(n && String(n).trim()) list.push({name: String(n).trim(), quantity: q? String(q).trim():''}); } return list; })()
      }));
      try{ localStorage.setItem(key, JSON.stringify({ts:Date.now(), data:mapped})); }catch(e){}
      lastExternalError = null;
      return mapped;
    }catch(e){ clearTimeout(timeout); console.warn('fetchExternalMeals failed', e); lastExternalError = e && e.message ? String(e.message) : String(e); return []; }
  }

  // fetch a single meal by TheMealDB id (lookup endpoint)
  async function fetchExternalMealById(idMeal){
    if(!idMeal) return null;
    const key = 'tm_lookup_' + String(idMeal);
  try{ const cached = JSON.parse(localStorage.getItem(key)||'null'); if(cached && (Date.now()-cached.ts)<TM_CACHE_TTL) return cached.data; }catch(e){}
    const controller = new AbortController(); const timeout = setTimeout(()=>controller.abort(),8000);
    try{
      const url = `https://www.themealdb.com/api/json/v1/1/lookup.php?i=${encodeURIComponent(idMeal)}`;
      const res = await fetch(url, { signal: controller.signal }); clearTimeout(timeout);
      if(!res.ok) return null; const j = await res.json(); const m=(j.meals||[])[0]; if(!m) return null;
      const mapped = {
        id: 'tm_' + m.idMeal,
        source: 'tm',
        sourceId: String(m.idMeal),
        title: m.strMeal || 'Sin t√≠tulo',
        cuisine: m.strArea || '',
        difficulty: 'medio',
        prepTime: 0,
        cookTime: 0,
        description: m.strInstructions || '',
        image: m.strMealThumb || '',
        ingredients: (()=>{ const list=[]; for(let i=1;i<=20;i++){ const n=m['strIngredient'+i]; const q=m['strMeasure'+i]; if(n && String(n).trim()) list.push({name: String(n).trim(), quantity: q? String(q).trim():''}); } return list; })()
      };
      try{ localStorage.setItem(key, JSON.stringify({ts:Date.now(), data:mapped})); }catch(e){}
      return mapped;
    }catch(e){ clearTimeout(timeout); console.warn('fetchExternalMealById failed', e); lastExternalError = e && e.message ? String(e.message) : String(e); return null; }
  }

  // Extended external search with multiple modes: name, ingredient, category, area, first-letter
  async function fetchExternalMealsBy(query, mode='name'){
    if(!query) return [];
    const qnorm = String(query).trim().toLowerCase();
    const key = `tm_cache_${mode}_` + qnorm;
    try{ const cached = JSON.parse(localStorage.getItem(key)||'null'); if(cached && (Date.now()-cached.ts)<TM_CACHE_TTL) return cached.data; }catch(e){}
    try{
      let url;
      if(mode==='name'){
        return await fetchExternalMeals(query); // existing behaviour and mapping
      } else if(mode==='ingredient'){
        url = `https://www.themealdb.com/api/json/v1/1/filter.php?i=${encodeURIComponent(query)}`;
      } else if(mode==='category'){
        url = `https://www.themealdb.com/api/json/v1/1/filter.php?c=${encodeURIComponent(query)}`;
      } else if(mode==='area'){
        url = `https://www.themealdb.com/api/json/v1/1/filter.php?a=${encodeURIComponent(query)}`;
      } else if(mode==='first-letter'){
        const ch = String(query).trim().charAt(0) || 'a'; url = `https://www.themealdb.com/api/json/v1/1/search.php?f=${encodeURIComponent(ch)}`;
      } else {
        return await fetchExternalMeals(query);
      }
      const controller = new AbortController(); const timeout = setTimeout(()=>controller.abort(),15000);
      const res = await fetch(url, { signal: controller.signal }); clearTimeout(timeout);
      if(!res.ok) return [];
      const j = await res.json();
      const meals = j.meals || [];
      // filter endpoints return minimal data (idMeal,strMeal,strMealThumb) - map to our simplified shape
      const mapped = meals.map(m=>({ id: 'tm_'+m.idMeal, source:'tm', sourceId:String(m.idMeal), title: m.strMeal || 'Sin t√≠tulo', cuisine: m.strArea||'', difficulty:'medio', prepTime:0, cookTime:0, description: '', image: m.strMealThumb || '', ingredients: [] }));
      try{ localStorage.setItem(key, JSON.stringify({ts:Date.now(), data:mapped})); }catch(e){}
      lastExternalError = null;
      return mapped;
    }catch(e){ console.warn('fetchExternalMealsBy failed', e); lastExternalError = e && e.message ? String(e.message) : String(e); return []; }
  }

  // fetch list of categories and areas for autocompletion
  async function fetchExternalLists(){
    // try cached lists
    try{
      const cachedC = JSON.parse(localStorage.getItem('tm_list_categories')||'null');
      const cachedA = JSON.parse(localStorage.getItem('tm_list_areas')||'null');
      if(cachedC && (Date.now()-cachedC.ts)<TM_CACHE_TTL && cachedA && (Date.now()-cachedA.ts)<TM_CACHE_TTL){ return {categories: cachedC.data, areas: cachedA.data}; }
    }catch(e){}
    try{
      const [resC, resA] = await Promise.all([
        fetch('https://www.themealdb.com/api/json/v1/1/list.php?c=list'),
        fetch('https://www.themealdb.com/api/json/v1/1/list.php?a=list')
      ]);
      const jC = await resC.json(); const jA = await resA.json();
      const cats = (jC.meals||[]).map(x=> (x.strCategory||'').trim()).filter(Boolean);
      const areas = (jA.meals||[]).map(x=> (x.strArea||'').trim()).filter(Boolean);
      try{ localStorage.setItem('tm_list_categories', JSON.stringify({ts:Date.now(), data:cats})); localStorage.setItem('tm_list_areas', JSON.stringify({ts:Date.now(), data:areas})); }catch(e){}
      return {categories:cats, areas:areas};
    }catch(e){ console.warn('fetchExternalLists failed', e); return {categories:[], areas:[]}; }
  }

  // Explore multiple categories/areas to aggregate many external recipes (shows minimal cards, detail on demand)
  async function exploreExternal(){
    const extToggle = document.getElementById('externalToggle');
    if(!extToggle || !extToggle.checked){ alert('Activa "Incluir recetas externas" antes de explorar.'); return; }
    const view = q('#view'); view.innerHTML=''; const sec = document.createElement('section'); sec.className='section'; const h=document.createElement('h2'); h.textContent='Explorar TheMealDB ‚Äî recopilando recetas'; sec.appendChild(h); const info = document.createElement('div'); info.textContent='Obteniendo categor√≠as y listando recetas (limitado para no saturar la API)...'; sec.appendChild(info); const grid=document.createElement('div'); grid.className='grid'; sec.appendChild(grid); view.appendChild(sec);
    try{
      const lists = await fetchExternalLists(); const cats = (lists.categories||[]).slice(0,8); if(cats.length===0){ info.textContent='No se pudieron obtener categor√≠as; prueba otra vez o usa el selector de b√∫squedas.'; return; }
      info.textContent = `Consultando ${cats.length} categor√≠as: ${cats.join(', ')}...`;
      // fetch filter results for each category (limited concurrency)
      const mealsMap = {};
      const tasks = cats.map(cat => async ()=>{
        try{ const url = `https://www.themealdb.com/api/json/v1/1/filter.php?c=${encodeURIComponent(cat)}`; const res = await fetch(url); if(!res.ok) return; const j = await res.json(); const arr = j.meals||[]; arr.forEach(m=>{ if(!mealsMap[m.idMeal]) mealsMap[m.idMeal] = { id:'tm_'+m.idMeal, source:'tm', sourceId: String(m.idMeal), title: m.strMeal, image: m.strMealThumb || '', cuisine: cat }; }); }catch(e){}
      });
      // run tasks in batches of 3
      const batchSize = 3; for(let i=0;i<tasks.length;i+=batchSize){ const batch = tasks.slice(i,i+batchSize).map(fn=>fn()); await Promise.all(batch); }
      const all = Object.values(mealsMap).slice(0,80); info.textContent = `Se encontraron ${all.length} recetas (mostrando hasta 80). Haz clic en "Ver detalle" para cargar la receta completa.`;
      const showImgs = shouldShowExternalImages();
      all.forEach(r=>{
        const card=document.createElement('article'); card.className='card'; const posterHtml = (showImgs && r.image) ? `<div class="poster"><img src="${r.image}" alt="${r.title}" loading="lazy"></div>` : `<div class="poster"><strong>${r.title}</strong></div>`;
        card.innerHTML = `${posterHtml}<div class="body"><h4>${r.title} <small style="opacity:.7">(externa)</small></h4><p class="muted">${r.cuisine}</p></div>`;
        const actions=document.createElement('div'); actions.className='actions'; const viewBtn=document.createElement('button'); viewBtn.className='btn'; viewBtn.textContent='Ver detalle'; viewBtn.addEventListener('click', ()=>{ // save state and open detail by id
          try{ const state={ q: (document.getElementById('search') && document.getElementById('search').value) || '', mode: (document.getElementById('externalMode')||{}).value || 'name' }; sessionStorage.setItem('lastCatalogState', JSON.stringify(state)); }catch(e){}
          renderExternalDetail({ id: r.id, source: r.source, sourceId: r.sourceId, title: r.title });
        }); actions.appendChild(viewBtn); card.appendChild(actions); grid.appendChild(card);
      });
      // scroll to results
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }catch(e){ console.error('exploreExternal failed', e); info.textContent = 'Error al explorar externos: '+ (e && e.message? e.message: String(e)); }
  }

  // map free-form cuisine/area strings to normalized keys used by CSS
  function getCuisineKey(c){
    if(!c) return 'default';
    const k = String(c).toLowerCase().trim();
    if(k.includes('ital')) return 'italian';
    if(k.includes('mex')) return 'mexican';
    if(k.includes('india') || k.includes('indian')) return 'indian';
    if(k.includes('japan') || k.includes('jap')) return 'japanese';
    if(k.includes('china') || k.includes('chinese')) return 'chinese';
    if(k.includes('franc')) return 'french';
    if(k.includes('esp') || k.includes('span')) return 'spanish';
    if(k.includes('medit') || k.includes('med')) return 'mediterranean';
    if(k.includes('greek')) return 'greek';
    if(k.includes('americana') || k.includes('american') || k.includes('usa') || k.includes('estados')) return 'american';
    if(k.includes('inter') || k.includes('int')) return 'international';
    // fallback: sanitize to class-friendly string
    return k.replace(/[^a-z0-9]+/g,'-');
  }

  // Pairings map: por cocina, recomendamos bebidas o vinos
  const PAIRINGS = {
    italian: ['Chianti', 'Prosecco', 'Vino blanco ligero'],
    mediterranean: ['Vino blanco', 'Ros√©'],
    mexican: ['Cerveza mexicana', 'Margarita', 'Mezcal'],
    japanese: ['Sake fr√≠o', 'T√© verde'],
    indian: ['Gew√ºrztraminer', 'Mango lassi'],
    chinese: ['Riesling', 'T√© de jazm√≠n'],
    french: ['Bordeaux', 'Champagne', 'Pinot Noir'],
    spanish: ['Rioja', 'Cava', 'Vermouth'],
    american: ['Zinfandel', 'IPA', 'Bourbon'],
    greek: ['Assyrtiko', 'Retsina'],
    argentine: ['Malbec', 'Torront√©s'],
    brasilera: ['Caipirinha', 'Cerveza lager'],
    brazilian: ['Caipirinha', 'Cerveza lager'],
    morrocan: ['T√© de menta', 'Vino tinto ligero'],
    marroqu√≠: ['T√© de menta', 'Vino tinto ligero'],
    moroccan: ['T√© de menta', 'Vino tinto ligero'],
    thai: ['Riesling', 'T√© helado'],
    international: ['Agua', 'Vino blanco'],
    default: ['Agua', 'Vino blanco']
  };

  function renderPairingsForCuisine(c){ const key = getCuisineKey(c); const items = PAIRINGS[key] || PAIRINGS['default']; const wrap = document.createElement('div'); wrap.className='pairings'; const h=document.createElement('h3'); h.textContent='Maridaje recomendado'; wrap.appendChild(h); const ul=document.createElement('ul'); items.forEach(it=>{ const li=document.createElement('li'); li.textContent=it; ul.appendChild(li); }); wrap.appendChild(ul); return wrap; }

  function renderTips(tips){ if(!tips || !tips.length) return null; const wrap=document.createElement('div'); wrap.className='tips'; const h=document.createElement('h3'); h.textContent='Tips'; wrap.appendChild(h); const ul=document.createElement('ul'); tips.forEach(t=>{ const li=document.createElement('li'); li.textContent = t; ul.appendChild(li); }); wrap.appendChild(ul); return wrap; }

  // Detailed maridajes por receta (alcoh√≥lico y sin alcohol)
  const MARIDAJES_DETAILED = {
    r1: { alcohol: ['Verdejo joven','Albari√±o'], nonAlcohol: ['Agua con gas con rodajas de lim√≥n y romero'] },
    r2: { alcohol: ['Riesling seco','Gew√ºrztraminer'], nonAlcohol: ['T√© fr√≠o de jengibre y lim√≥n'] },
    r3: { alcohol: ['Oporto Ruby','Pedro Xim√©nez'], nonAlcohol: ['Caf√© espresso','Chocolate caliente amargo'] },
    r4: { alcohol: ['Moscato d\'Asti'], nonAlcohol: ['Smoothie de mango','Zumo de naranja natural'] },
    r5: { alcohol: ['Sauvignon Blanc','Verdejo'], nonAlcohol: ['Kombucha de jengibre','Limonada con hierbabuena'] },
    r6: { alcohol: ['Tempranillo joven','Garnacha suave'], nonAlcohol: ['T√© negro con especias','Agua con un toque de lima'] },
    r7: { alcohol: ['Pinot Grigio'], nonAlcohol: ['Limonada casera con albahaca fresca'] },
    r8: { alcohol: ['Chardonnay sin madera','Cerveza lager ligera'], nonAlcohol: ['Agua con gas con lima','Kombucha c√≠trica'] },
    r9: { alcohol: ['Chardonnay con leve barrica','Rosado seco'], nonAlcohol: ['T√© verde con miel y lim√≥n'] },
    r10:{ alcohol: ['Viognier','Chardonnay suave'], nonAlcohol: ['Zumo de manzana caliente con canela'] },
    r11:{ alcohol: ['Sauvignon Blanc','Rosado seco'], nonAlcohol: ['Agua con pepino y menta','Kombucha de lim√≥n'] },
    r12:{ alcohol: ['Cava dulce','Vino espumoso semiseco'], nonAlcohol: ['Caf√© latte','Batido de vainilla'] },
    r13:{ alcohol: ['Sake fr√≠o','Albari√±o'], nonAlcohol: ['T√© verde japon√©s (sencha)'] },
    r14:{ alcohol: ['Gew√ºrztraminer','Riesling off-dry'], nonAlcohol: ['T√© helado de jazm√≠n','Agua con pepino'] },
    r15:{ alcohol: ['Pinot Noir','Merlot suave'], nonAlcohol: ['Mosto tinto','T√© negro con ciruela'] },
    r16:{ alcohol: ['Verdejo','Rosado valenciano'], nonAlcohol: ['Agua con gas con piel de naranja','Kombucha floral'] },
    r17:{ alcohol: ['Syrah','Garnacha madura'], nonAlcohol: ['Zumo de granada','T√© fr√≠o de menta'] },
    r18:{ alcohol: ['Zinfandel','Malbec'], nonAlcohol: ['Cola artesanal','T√© helado de durazno'] },
    r19:{ alcohol: ['Malbec joven','Torront√©s'], nonAlcohol: ['Mate fr√≠o','Limonada con jengibre'] },
    r20:{ alcohol: ['Cabernet Sauvignon','Syrah'], nonAlcohol: ['Zumo de frutas tropicales','Agua con lima y menta'] },
    r21:{ alcohol: ['Garnacha','Vino tinto del R√≥dano'], nonAlcohol: ['T√© moruno (menta)'] },
    r22:{ alcohol: ['Riesling','Sauvignon Blanc'], nonAlcohol: ['Agua de coco','Limonada con jengibre'] }
  };

  function renderMaridajeDetailedById(id){ const m = MARIDAJES_DETAILED[id]; if(!m) return null; const wrap=document.createElement('div'); wrap.className='pairings'; const h=document.createElement('h3'); h.textContent='Maridaje ideal ‚Äî (alcoh√≥lico y sin alcohol)'; wrap.appendChild(h); const alc=document.createElement('div'); alc.className='pairing-alcohol'; const alcH=document.createElement('strong'); alcH.textContent='Vino / Bebida alcoh√≥lica: '; alc.appendChild(alcH); alc.appendChild(document.createTextNode(m.alcohol.join(', '))); wrap.appendChild(alc); const na=document.createElement('div'); na.className='pairing-nonalc'; const naH=document.createElement('strong'); naH.textContent='Sin alcohol: '; na.appendChild(naH); na.appendChild(document.createTextNode(m.nonAlcohol.join(', '))); wrap.appendChild(na); return wrap; }

  // Render general maridaje catalog (bebidas) - route #/maridaje
  function renderMaridajeCatalog(){ const view=q('#view'); view.innerHTML=''; const sec=document.createElement('section'); sec.className='section'; const h=document.createElement('h2'); h.textContent='Maridaje general ‚Äî Bebidas'; sec.appendChild(h);
    // build beverages list from PAIRINGS and detailed maridajes
    const bevSet = new Set(); Object.values(PAIRINGS).flat().forEach(b=>bevSet.add(b)); Object.values(MARIDAJES_DETAILED).forEach(d=>{ (d.alcohol||[]).forEach(b=>bevSet.add(b)); (d.nonAlcohol||[]).forEach(b=>bevSet.add(b)); });
    const list=document.createElement('div'); list.className='beverages'; Array.from(bevSet).sort().forEach(b=>{ const item=document.createElement('div'); item.className='beverage-item'; const title=document.createElement('button'); title.className='btn'; title.textContent=b; title.addEventListener('click', ()=>{ renderBeverageDetail(b); }); item.appendChild(title); list.appendChild(item); }); sec.appendChild(list); view.appendChild(sec); }

  function renderBeverageDetail(bev){ const view=q('#view'); view.innerHTML=''; const sec=document.createElement('section'); sec.className='section beverage-detail'; const h=document.createElement('h2'); h.textContent='Bebida: '+bev; sec.appendChild(h); const p=document.createElement('p'); p.textContent='Recetas que combinan con '+bev+':'; sec.appendChild(p);
    const ul=document.createElement('ul'); // find recipes that mention this beverage in detailed maridaje or pairings
    RECIPES.forEach(r=>{ const det = MARIDAJES_DETAILED[r.id]; let matched=false; if(det){ if(det.alcohol && det.alcohol.includes(bev)) matched=true; if(det.nonAlcohol && det.nonAlcohol.includes(bev)) matched=true; }
      // also check recipe.pairings array if exists
      if(r.pairings && r.pairings.includes(bev)) matched=true;
      // also check PAIRINGS map by cuisine
      const pc = PAIRINGS[getCuisineKey(r.cuisine)]; if(pc && pc.includes(bev)) matched=true;
      if(matched){ const li=document.createElement('li'); const a=document.createElement('a'); a.href='#/receta/'+r.id; a.textContent = r.title + ' (' + r.cuisine + ')'; li.appendChild(a); ul.appendChild(li); }
    });
    sec.appendChild(ul);
  // backlink
  const back=document.createElement('button'); back.className='btn'; back.textContent='Volver a Maridaje general'; back.addEventListener('click', ()=>{ location.hash = '#/maridaje'; navigate(); }); sec.appendChild(back);
    view.appendChild(sec);
  }

  // routing (incluye maridaje)
  function navigate(){ const hash=location.hash || '#/catalogo'; const view=q('#view'); view.innerHTML=''; if(hash.startsWith('#/catalogo')) return renderCatalog(); if(hash.startsWith('#/receta/')){ const id=hash.split('/')[2]; return renderRecipe(id); } if(hash.startsWith('#/planner')) return renderPlanner(); if(hash.startsWith('#/lista-compra')) return renderShopping(); if(hash.startsWith('#/nuevo')) return renderNewRecipe(); if(hash.startsWith('#/maridaje')) return renderMaridajeCatalog(); return renderCatalog(); }

  // route: new recipe form (POST to mock API)
  if(!window.routesAdded){
    // we will support #/nuevo route by checking hash in navigate (render below)
    window.routesAdded = true;
  }

  // search (save lastSearch)
  const searchInput=q('#search'); searchInput.addEventListener('input', debounce(()=>{ const v=searchInput.value.trim().toLowerCase(); localStorage.setItem('lastSearch', v); renderCatalog(v); },300));

  // catalog
  async function renderCatalog(qterm=''){
    const view=q('#view'); view.innerHTML=''; const section=document.createElement('section'); section.className='section'; const grid=document.createElement('div'); grid.className='grid';
  // add quick link to maridaje general (bebidas) and external search mode
    const topControls=document.createElement('div'); topControls.style.display='flex'; topControls.style.gap='8px'; topControls.style.alignItems='center'; topControls.style.marginBottom='10px';
    const marBtn=document.createElement('button'); marBtn.className='btn'; marBtn.textContent='Maridaje general (bebidas)'; marBtn.addEventListener('click', ()=> location.hash='#/maridaje'); topControls.appendChild(marBtn);
    // external search mode selector
    const extModeLabel = document.createElement('label'); extModeLabel.style.display='flex'; extModeLabel.style.alignItems='center'; extModeLabel.style.gap='6px'; extModeLabel.style.fontSize='0.9rem'; extModeLabel.textContent = 'Buscar externo por:';
    const extModeSel = document.createElement('select'); extModeSel.id = 'externalMode'; ['name','ingredient','category','area','first-letter'].forEach(m=>{ const o=document.createElement('option'); o.value=m; o.textContent = m==='name'?'Nombre':m==='ingredient'?'Ingrediente':m==='category'?'Categor√≠a':m==='area'?'Nacionalidad':'Inicial'; extModeSel.appendChild(o); }); extModeLabel.appendChild(extModeSel); topControls.appendChild(extModeLabel);
    // suggestions datalist (populated when category/area mode selected)
    const dataList = document.createElement('datalist'); dataList.id = 'externalSuggestions'; document.body.appendChild(dataList);
    // when mode changes, populate datalist from API lists
    extModeSel.addEventListener('change', async ()=>{
      const mode = extModeSel.value; const list = document.getElementById('externalSuggestions'); list.innerHTML='';
      if(mode==='category' || mode==='area'){
        const lists = await fetchExternalLists(); const items = mode==='category'? lists.categories : lists.areas;
        items.forEach(it=>{ const opt=document.createElement('option'); opt.value = it; list.appendChild(opt); });
        // attach datalist to search input
        const searchEl = document.getElementById('search'); if(searchEl) searchEl.setAttribute('list', 'externalSuggestions');
      } else {
        const searchEl = document.getElementById('search'); if(searchEl) searchEl.removeAttribute('list');
      }
    });
    section.appendChild(topControls);
    // local results
  let list = RECIPES.filter(r=>{ if(!qterm) return true; return r.title.toLowerCase().includes(qterm) || (r.description||'').toLowerCase().includes(qterm) || r.ingredients.some(i=>i.name.toLowerCase().includes(qterm)); });
    if(showOnlyFavorites){ list = list.filter(r=> isFavorite(r.id)); }

    // If external toggle is enabled and we have a query, fetch external recipes
    const extToggle = document.getElementById('externalToggle');
    let externalResults = [];
    if(extToggle && extToggle.checked && qterm){
      const loadingNote = document.createElement('div'); loadingNote.textContent = 'Buscando recetas externas...'; loadingNote.style.gridColumn='1/-1'; section.appendChild(loadingNote);
      const mode = (document.getElementById('externalMode')||{}).value || 'name';
      try{ externalResults = await fetchExternalMealsBy(qterm, mode); }catch(e){ externalResults = []; }
      // if no external results and we captured an external error, show it and offer retry/help
      if((!externalResults || externalResults.length===0) && lastExternalError){
        const errDiv = document.createElement('div'); errDiv.className='muted'; errDiv.style.gridColumn='1/-1'; errDiv.style.border='1px dashed var(--muted)'; errDiv.style.padding='8px'; errDiv.style.marginTop='8px';
        errDiv.innerHTML = `<strong>Error conectando a TheMealDB:</strong> ${String(lastExternalError).slice(0,200)}<br>`;
        const retry = document.createElement('button'); retry.className='btn'; retry.textContent='Reintentar b√∫squeda externa'; retry.addEventListener('click', ()=>{ renderCatalog(qterm); });
        const help = document.createElement('button'); help.className='btn'; help.textContent='Ver pasos de soluci√≥n'; help.addEventListener('click', ()=>{ alert('Pasos de soluci√≥n:\n1) Aseg√∫rate de servir la app con un servidor local (npm start).\n2) Revisa la consola del navegador (F12) para ver errores CORS o de red.\n3) Si est√°s en una red corporativa, prueba con otra red o VPN.\n4) Comprueba que https://www.themealdb.com est√° accesible desde tu navegador.'); });
        errDiv.appendChild(retry); errDiv.appendChild(help);
        section.appendChild(errDiv);
      }
    }

    // render local results
    list.forEach(r=>{ const card=document.createElement('article'); card.className='card';
      const posterHtml = r.image ? `<div class="poster"><img src="${r.image}" alt="${r.title}" loading="lazy"></div>` : `<div class="poster"><strong>${r.title}</strong></div>`;
      card.innerHTML=`${posterHtml}<div class="body"><h4>${r.title}</h4><p class="muted">${r.cuisine} ‚Ä¢ ${r.difficulty} ‚Ä¢ ${r.prepTime + (r.cookTime||0)} min</p></div>`;
      const actions=document.createElement('div'); actions.className='actions'; const favBtn=document.createElement('button'); favBtn.className='icon-btn fav'; favBtn.innerHTML = isFavorite(r.id)?'‚ù§':'ü§ç'; favBtn.title='Marcar favorito'; favBtn.addEventListener('click', (e)=>{ e.stopPropagation(); toggleFavorite(r.id); favBtn.innerHTML = isFavorite(r.id)?'‚ù§':'ü§ç'; }); const viewBtn=document.createElement('button'); viewBtn.className='btn'; viewBtn.textContent='Ver'; viewBtn.addEventListener('click', ()=> location.hash = '#/receta/'+r.id); const addBtn=document.createElement('button'); addBtn.textContent='A√±adir al planner'; addBtn.addEventListener('click', ()=>{ addToPlanner(r.id); alert('A√±adido al planner (puedes editar en Planner)'); }); actions.appendChild(favBtn); actions.appendChild(viewBtn); actions.appendChild(addBtn); card.appendChild(actions); grid.appendChild(card); });

    // render external results (if any)
    if(externalResults && externalResults.length){
      const showImgs = shouldShowExternalImages();
      externalResults.forEach(r=>{
        const card=document.createElement('article'); card.className='card';
        const posterHtml = (showImgs && r.image) ? `<div class="poster"><img src="${r.image}" alt="${r.title}" loading="lazy"></div>` : `<div class="poster"><strong>${r.title}</strong></div>`;
        card.innerHTML=`${posterHtml}<div class="body"><h4>${r.title} <small style="opacity:.7">(externa)</small></h4><p class="muted">${r.cuisine}</p><p class="muted">${r.description}</p></div>`;
        const actions=document.createElement('div'); actions.className='actions';
        const favBtn=document.createElement('button'); favBtn.className='icon-btn fav'; favBtn.innerHTML = isFavorite(r.id)?'‚ù§':'ü§ç'; favBtn.title='Marcar favorito'; favBtn.addEventListener('click', (e)=>{ e.stopPropagation(); toggleFavorite(r.id); favBtn.innerHTML = isFavorite(r.id)?'‚ù§':'ü§ç'; });
        const viewBtn=document.createElement('button'); viewBtn.className='btn'; viewBtn.textContent='Ver';
        viewBtn.addEventListener('click', ()=> {
          // if this result is minimal (no ingredients) we fetch detail by id for the user
          if((!r.ingredients || r.ingredients.length===0) && r.sourceId){ renderExternalDetail({ id: r.id, source: r.source, sourceId: r.sourceId, title: r.title }); }
          else { renderExternalDetail(r); }
        });
        actions.appendChild(favBtn); actions.appendChild(viewBtn); card.appendChild(actions); grid.appendChild(card);
      });
    }

    section.appendChild(grid); view.appendChild(section); updateFavCount();
  }

  // render detail for an external meal object (not in RECIPES)
  async function renderExternalDetail(m){
    const view=q('#view'); view.innerHTML=''; const sec=document.createElement('section'); sec.className='section'; const title=document.createElement('h2'); title.textContent = m.title || 'Receta externa'; sec.appendChild(title);
    const loading = document.createElement('div'); loading.textContent = 'Cargando detalle...'; loading.style.opacity='0.7'; sec.appendChild(loading); view.appendChild(sec);

    // If this object references TheMealDB id, fetch full detail for a better view
    let full = m;
    if(m && (m.source === 'tm' || (typeof m.id === 'string' && m.id.startsWith('tm_')))){
      const idMeal = m.sourceId || (m.id && m.id.replace(/^tm_/,'') );
      try{ const fetched = await fetchExternalMealById(idMeal); if(fetched) full = fetched; }catch(e){ console.warn('no se pudo obtener detalle externo', e); }
    }

    // replace loading with actual content
    sec.innerHTML = '';
    const title2 = document.createElement('h2'); title2.textContent = full.title || 'Receta externa'; sec.appendChild(title2);
    // decorative background
    const cuisineKey = getCuisineKey(full.cuisine || full.area || full.nationality);
    sec.classList.add('recipe-bg', 'bg-' + (cuisineKey || 'default'));
    sec.setAttribute('aria-label', 'Detalle de receta: ' + (full.title || ''));

    // image (respect user preference)
    if(shouldShowExternalImages() && full.image){ const img=document.createElement('img'); img.src = full.image; img.alt = full.title || ''; img.loading='lazy'; img.style.maxWidth='360px'; sec.appendChild(img); }

    const p=document.createElement('p'); p.textContent = full.description || ''; sec.appendChild(p);

  // import button: copy into RECIPES/local storage and optionally post to mock server
    const actions = document.createElement('div'); actions.style.display='flex'; actions.style.gap='8px'; const importBtn = document.createElement('button'); importBtn.className='btn'; importBtn.textContent = 'Importar receta (local)'; importBtn.addEventListener('click', async ()=>{
      // create a local recipe structure (avoid storing remote image by default)
      const newId = 'u_' + Date.now(); const newRec = {
        id: newId,
        title: full.title || 'Sin t√≠tulo',
        servings: full.servings || 2,
        prepTime: full.prepTime || 0,
        cookTime: full.cookTime || 0,
        difficulty: full.difficulty || 'medio',
        cuisine: full.cuisine || '',
        tags: full.tags || ['importada'],
        ingredients: (full.ingredients||[]).map(it=>({ name: it.name, quantity: (parseFloat(it.quantity)||0), unit: '' })),
        steps: [{text: full.description||'', time:0}],
        rating: 0, votes:0, author: 'Importado', description: full.description || ''
      };
      // persist locally in localStorage user_recipes_local
      try{
        const list = JSON.parse(localStorage.getItem('user_recipes_local')||'[]'); list.push(newRec); localStorage.setItem('user_recipes_local', JSON.stringify(list)); RECIPES.push(newRec); alert('Receta importada localmente. Aparecer√° en el Cat√°logo.');
      }catch(e){ console.error('import error', e); alert('Error al importar localmente.'); }

      // try to POST to mock server (if available)
      try{
        const res = await fetch('http://localhost:3000/user_recipes', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(newRec) });
        if(res.ok) alert('Tambi√©n enviada al servidor mock (http://localhost:3000)');
      }catch(e){ /* ignore network errors */ }
    });
    actions.appendChild(importBtn);

    const addPlanBtn = document.createElement('button'); addPlanBtn.className='btn'; addPlanBtn.textContent='A√±adir al planner'; addPlanBtn.addEventListener('click', async ()=>{
      // if this is an external recipe, auto-import a local copy so planner/shopping can reference it
      if(full && full.id && String(full.id).startsWith('tm_')){
        const existing = RECIPES.find(x=> x.title === full.title && (x.author||'')==='Importado');
        let toId = existing ? existing.id : null;
        if(!toId){
          const newId = 'u_' + Date.now(); const newRec = {
            id: newId,
            title: full.title || 'Sin t√≠tulo',
            servings: full.servings || 2,
            prepTime: full.prepTime || 0,
            cookTime: full.cookTime || 0,
            difficulty: full.difficulty || 'medio',
            cuisine: full.cuisine || '',
            tags: full.tags || ['importada'],
            ingredients: (full.ingredients||[]).map(it=>({ name: it.name, quantity: (parseFloat(it.quantity)||0), unit: '' })),
            steps: [{text: full.description||'', time:0}],
            rating: 0, votes:0, author: 'Importado', description: full.description || ''
          };
          try{ const list = JSON.parse(localStorage.getItem('user_recipes_local')||'[]'); list.push(newRec); localStorage.setItem('user_recipes_local', JSON.stringify(list)); RECIPES.push(newRec); toId = newId; }
          catch(e){ console.error('import error', e); alert('No se pudo importar la receta para planner.'); return; }
        }
        addToPlanner(toId); alert('Receta importada y a√±adida al planner');
      } else {
        const idToAdd = (full && full.id) ? full.id : ('tm_'+(full.sourceId||Date.now())); addToPlanner(idToAdd); alert('A√±adido al planner');
      }
    }); actions.appendChild(addPlanBtn);

    // Back to catalog button: restore last catalog state if present
    const backCat = document.createElement('button'); backCat.className='btn'; backCat.textContent='Volver al cat√°logo'; backCat.style.marginLeft='8px'; backCat.addEventListener('click', ()=>{
      try{
        const st = JSON.parse(sessionStorage.getItem('lastCatalogState') || 'null');
        if(st){ const searchEl = document.getElementById('search'); const modeEl = document.getElementById('externalMode'); if(searchEl) searchEl.value = st.q || ''; if(modeEl) modeEl.value = st.mode || 'name'; // ensure datalist updated
          // if mode is category/area, trigger change to refill datalist
          if(modeEl && (st.mode==='category' || st.mode==='area')) modeEl.dispatchEvent(new Event('change'));
          // render catalog with restored query
          location.hash = '#/catalogo'; navigate(); renderCatalog((st.q||'').trim().toLowerCase());
          return;
        }
      }catch(e){}
      // fallback: simple navigate
      location.hash = '#/catalogo'; navigate();
    }); actions.appendChild(backCat);

    sec.appendChild(actions);

    // Tips and pairings
    const tipsEl = renderTips(full.tips || full.tips || []);
    if(tipsEl) sec.appendChild(tipsEl);
    const pairEl = renderPairingsForCuisine(full.cuisine || full.area || full.nationality);
    if(pairEl) sec.appendChild(pairEl);

    // Ingredients
    const ul=document.createElement('ul'); (full.ingredients||[]).forEach(it=>{ const li=document.createElement('li'); li.textContent = `${it.quantity ? it.quantity + ' ' : ''}${it.unit?it.unit+' ':' '}${it.name}`.trim(); ul.appendChild(li); }); sec.appendChild(ul);

    view.appendChild(sec);
  }

  // recipe detail
  function renderRecipe(id){ const r = RECIPES.find(x=>x.id===id); const view=q('#view'); if(!r){ view.innerHTML='<p>Receta no encontrada</p>'; return; } view.innerHTML=''; const sec=document.createElement('section'); sec.className='section'; sec.innerHTML=`<h2>${r.title}</h2><p class="muted">${r.cuisine} ‚Ä¢ ${r.difficulty} ‚Ä¢ ${r.prepTime + (r.cookTime||0)} min</p><p>${r.description||''}</p>`; // portion scaler
    // decorative background according to cuisine/nationality
    const ckey = getCuisineKey(r.cuisine || r.area || r.nationality);
    sec.classList.add('recipe-bg', 'bg-' + (ckey || 'default'));
    sec.setAttribute('aria-label', 'Detalle de receta: ' + (r.title || ''));
    const scalerDiv=document.createElement('div'); scalerDiv.className='portion-controls'; let servings = r.servings || 1; const lbl=document.createElement('div'); lbl.textContent = 'Porciones: '+servings; const dec=document.createElement('button'); dec.textContent='-'; const inc=document.createElement('button'); inc.textContent='+'; dec.addEventListener('click', ()=>{ if(servings>1) servings--; lbl.textContent='Porciones: '+servings; renderIngredients(); localStorage.setItem('servings:'+r.id,servings); }); inc.addEventListener('click', ()=>{ servings++; lbl.textContent='Porciones: '+servings; renderIngredients(); localStorage.setItem('servings:'+r.id,servings); }); scalerDiv.appendChild(dec); scalerDiv.appendChild(lbl); scalerDiv.appendChild(inc); sec.appendChild(scalerDiv);
  const ingList=document.createElement('ul'); ingList.className='ingredients-list'; function renderIngredients(){ ingList.innerHTML=''; (r.ingredients||[]).forEach(ing=>{ const qty=(ing.quantity * servings)/r.servings; const disp=convertDisplay(qty,ing.unit||''); const displayValue = disp && typeof disp.value === 'number' ? Math.round(disp.value*100)/100 : disp.value; const valueText = isFinite(displayValue)? formatFraction(displayValue) : displayValue; const text = ((valueText||'') + (disp.unit? ' '+disp.unit : '') + ' ' + ing.name).trim(); const li=document.createElement('li'); li.textContent=text; ingList.appendChild(li); }); } renderIngredients(); sec.appendChild(ingList);
    const stepsOl=document.createElement('ol'); (r.steps||[]).forEach(s=>{ const li=document.createElement('li'); const p=document.createElement('div'); p.textContent=s.text; li.appendChild(p); if(s.time && s.time>0){ const controls=document.createElement('div'); const start=document.createElement('button'); start.textContent='Start'; const pause=document.createElement('button'); pause.textContent='Pause'; const reset=document.createElement('button'); reset.textContent='Reset'; const display=document.createElement('span'); let t=s.time*60; display.textContent = s.time+':00'; let interval=null; function render(){ const m=Math.floor(t/60); const ss=t%60; display.textContent=m+':'+String(ss).padStart(2,'0'); } start.addEventListener('click', ()=>{ if(interval) return; interval=setInterval(()=>{ if(t<=0){ clearInterval(interval); interval=null; try{ new Notification('Temporizador',{body:`Paso ${s.text} finalizado`}); }catch(e){ display.style.opacity='0.3'; } return; } t--; render(); },1000); }); pause.addEventListener('click', ()=>{ if(interval){ clearInterval(interval); interval=null; } }); reset.addEventListener('click', ()=>{ t=s.time*60; render(); if(interval){ clearInterval(interval); interval=null; } }); controls.appendChild(display); controls.appendChild(start); controls.appendChild(pause); controls.appendChild(reset); li.appendChild(controls); }
      stepsOl.appendChild(li); }); sec.appendChild(stepsOl);
      // detailed maridaje (preferencia por entradas espec√≠ficas)
      const marDetailed = renderMaridajeDetailedById(r.id);
      if(marDetailed) sec.appendChild(marDetailed);
      else {
        const pairElLocal = renderPairingsForCuisine(r.cuisine || r.area || r.nationality);
        if(pairElLocal) sec.appendChild(pairElLocal);
      }
      const tipsElLocal = renderTips(r.tips || []);
      if(tipsElLocal) sec.appendChild(tipsElLocal);
      view.appendChild(sec);
  }

  // render New Recipe form and POST to mock server (json-server)
  async function renderNewRecipe(){ const view=q('#view'); view.innerHTML=''; const sec=document.createElement('section'); sec.className='section'; sec.innerHTML=`<h2>A√±adir receta (usuario)</h2>
    <form id="new-recipe-form">
      <label>T√≠tulo: <input id="nr-title" name="title" required></label><br><br>
      <label>Descripci√≥n: <textarea id="nr-desc" name="description" required></textarea></label><br><br>
      <label>Ingredientes (una por l√≠nea, formato: cantidad unidad nombre):<br>
        <textarea id="nr-ings" placeholder="2 unit pan\n200 g harina" rows="4"></textarea>
      </label><br>
      <div id="nr-error" style="color:#b00020"></div>
      <button type="submit" class="btn">Enviar</button>
    </form>`;
    view.appendChild(sec);
    const form = document.getElementById('new-recipe-form');
    form.addEventListener('submit', async (e)=>{
      e.preventDefault(); const err = document.getElementById('nr-error'); err.textContent='';
      const title = document.getElementById('nr-title').value.trim(); const desc = document.getElementById('nr-desc').value.trim(); const ingsRaw = document.getElementById('nr-ings').value.trim();
      // client-side validation
      if(!title || !desc){ err.textContent='T√≠tulo y descripci√≥n son obligatorios.'; return; }
      // sanitize: remove tags to prevent XSS (we'll also use textContent when rendering)
      const sanitize = s => s.replace(/<[^>]*>?/gm, '');
      const payload = { title: sanitize(title), description: sanitize(desc), ingredients: [] };
      if(ingsRaw){ payload.ingredients = ingsRaw.split('\n').map(l=>{ const parts=l.trim().split(/\s+/); if(parts.length===1) return {name:parts[0]}; if(parts.length===2) return {quantity:parts[0], name:parts[1]}; return {quantity:parts[0], unit:parts[1], name:parts.slice(2).join(' ')}; }); }

      // POST to mock server
      try{
        const res = await fetch('http://localhost:3000/user_recipes', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)});
        if(!res.ok) throw new Error('Error al guardar en el servidor mock (aseg√∫rate de ejecutar json-server)');
        alert('Receta enviada correctamente (mock)'); form.reset(); window.location.hash='#/catalogo';
      }catch(err2){ console.error(err2); err.textContent = err2.message; }
    });
  }

  // planner
  function addToPlanner(id){ const planner = JSON.parse(localStorage.getItem('planner')||'{}'); planner['mon-breakfast']=planner['mon-breakfast']||[]; planner['mon-breakfast'].push(id); localStorage.setItem('planner',JSON.stringify(planner)); }
  function renderPlanner(){ const view=q('#view'); view.innerHTML=''; const sec=document.createElement('section'); sec.className='section'; sec.innerHTML='<h2>Planner semanal</h2><p>Drag & drop no disponible en versi√≥n file://, usa "A√±adir al planner" en cat√°logo para poblar.</p>'; const grid=document.createElement('div'); grid.className='planner-grid'; const days=['Lun','Mar','Mi√©','Jue','Vie','S√°b','Dom']; for(let d=0; d<7; d++){ const cell=document.createElement('div'); cell.className='planner-cell'; cell.dataset.day=d; const h=document.createElement('h4'); h.textContent=days[d]; cell.appendChild(h); grid.appendChild(cell); } sec.appendChild(grid); // render items
    const planner=JSON.parse(localStorage.getItem('planner')||'{}'); Object.keys(planner).forEach(k=>{ const ids=planner[k]; ids.forEach(id=>{ const r=RECIPES.find(rr=>rr.id===id) || null; const el=document.createElement('div'); el.textContent = r ? r.title : id; el.style.background='var(--accent)'; el.style.margin='4px 0'; el.style.padding='2px 4px'; grid.children[0].appendChild(el); }); }); view.appendChild(sec); }

  // Lista: ahora muestra agrupaci√≥n de recetas (por duraci√≥n, dificultad o nacionalidad) y mantiene la funcionalidad de lista de compra
  function renderShopping(){
    const view=q('#view'); view.innerHTML=''; const sec=document.createElement('section'); sec.className='section';
    const h=document.createElement('h2'); h.textContent = 'Lista / Agrupar recetas'; sec.appendChild(h);

    // controls
    const controls = document.createElement('div'); controls.className='list-controls';
    // group by
    const grpLabel = document.createElement('label'); grpLabel.textContent='Agrupar por:'; const grpSel = document.createElement('select'); grpSel.id='groupBy'; ['none','duration','difficulty','cuisine'].forEach(opt=>{ const o=document.createElement('option'); o.value=opt; o.textContent = opt==='none' ? 'Ninguno' : (opt==='duration'?'Duraci√≥n':opt==='difficulty'?'Dificultad':'Nacionalidad'); grpSel.appendChild(o); }); grpLabel.appendChild(grpSel); controls.appendChild(grpLabel);
    // sort order
    const sortLabel = document.createElement('label'); sortLabel.textContent='Orden:'; const sortSel = document.createElement('select'); sortSel.id='sortOrder'; ['asc','desc'].forEach(o=>{ const el=document.createElement('option'); el.value=o; el.textContent = o==='asc' ? 'Ascendente' : 'Descendente'; sortSel.appendChild(el); }); sortLabel.appendChild(sortSel); controls.appendChild(sortLabel);
    // planner-only toggle
    const plannerLabel = document.createElement('label'); plannerLabel.style.display='flex'; plannerLabel.style.alignItems='center'; plannerLabel.style.gap='6px'; const plannerChk = document.createElement('input'); plannerChk.type='checkbox'; plannerChk.id='plannerOnly'; plannerLabel.appendChild(plannerChk); plannerLabel.appendChild(document.createTextNode('Mostrar solo recetas del planner')); controls.appendChild(plannerLabel);
    // reset / apply
    const applyBtn = document.createElement('button'); applyBtn.className='btn'; applyBtn.textContent='Aplicar'; controls.appendChild(applyBtn);
    sec.appendChild(controls);

    // container for grouped recipes
    const groupsContainer = document.createElement('div'); groupsContainer.id='groupsContainer'; sec.appendChild(groupsContainer);

    // keep shopping section below
    const shopWrap = document.createElement('div'); shopWrap.style.marginTop='18px'; shopWrap.innerHTML = '<h3>Generar lista de compra desde planner</h3>';
    const genBtn=document.createElement('button'); genBtn.className='btn'; genBtn.textContent='Generar desde planner'; shopWrap.appendChild(genBtn);
    const shopUl=document.createElement('ul'); shopWrap.appendChild(shopUl);
    const expJson=document.createElement('button'); expJson.className='btn'; expJson.textContent='Exportar JSON'; shopWrap.appendChild(expJson);
    const expCsv=document.createElement('button'); expCsv.className='btn'; expCsv.textContent='Exportar CSV'; shopWrap.appendChild(expCsv);
    sec.appendChild(shopWrap);

    // helper functions
    function getTotalTime(r){ return (r.prepTime||0) + (r.cookTime||0); }
    function durationKeyLabel(mins){ if(mins<=15) return 'Corta (‚â§15 min)'; if(mins<=40) return 'Media (16-40 min)'; return 'Larga (>40 min)'; }

    function collectRecipes(){ const plannerIds = Object.values(JSON.parse(localStorage.getItem('planner')||'{}')).flat(); let source = RECIPES.slice(); if(plannerChk.checked){ source = RECIPES.filter(r=> plannerIds.includes(r.id)); } return source; }

    function renderGroups(){ groupsContainer.innerHTML=''; const recipes = collectRecipes(); if(recipes.length===0){ const p=document.createElement('p'); p.textContent = plannerChk.checked ? 'No hay recetas en el planner.' : 'No hay recetas.'; groupsContainer.appendChild(p); return; }
      const groupBy = grpSel.value; const sortOrder = sortSel.value;
      let groups = new Map();
      if(groupBy==='none'){
        groups.set('Todas las recetas', recipes.slice().sort((a,b)=> a.title.localeCompare(b.title)));
      } else if(groupBy==='duration'){
        recipes.forEach(r=>{ const key = durationKeyLabel(getTotalTime(r)); if(!groups.has(key)) groups.set(key,[]); groups.get(key).push(r); });
      } else if(groupBy==='difficulty'){
        recipes.forEach(r=>{ const key = (r.difficulty||'Desconocida'); if(!groups.has(key)) groups.set(key,[]); groups.get(key).push(r); });
      } else if(groupBy==='cuisine'){
        recipes.forEach(r=>{ const key = r.cuisine || 'Sin especificar'; if(!groups.has(key)) groups.set(key,[]); groups.get(key).push(r); });
      }
      // sort groups and items
      const keys = Array.from(groups.keys()).sort((a,b)=> a.localeCompare(b)); if(sortSel.value==='desc') keys.reverse();
      keys.forEach(k=>{ let items = groups.get(k) || []; items.sort((a,b)=> a.title.localeCompare(b.title)); if(sortOrder==='desc') items.reverse(); const gdiv=document.createElement('div'); gdiv.className='recipe-group'; const gh=document.createElement('div'); gh.className='group-header'; gh.textContent = `${k} (${items.length})`; gdiv.appendChild(gh); items.forEach(it=>{ const ri=document.createElement('div'); ri.className='recipe-item'; const left=document.createElement('div'); const a=document.createElement('a'); a.href = '#/receta/'+it.id; a.textContent = it.title; left.appendChild(a); const meta=document.createElement('div'); meta.className='meta'; meta.textContent = `${getTotalTime(it)} min ‚Ä¢ ${it.difficulty || ''} ‚Ä¢ ${it.cuisine || ''}`; ri.appendChild(left); ri.appendChild(meta); const controls=document.createElement('div'); controls.style.display='flex'; controls.style.gap='6px'; const addBtn=document.createElement('button'); addBtn.className='btn'; addBtn.textContent='A√±adir al planner'; addBtn.addEventListener('click', ()=>{ addToPlanner(it.id); alert('A√±adido al planner'); }); controls.appendChild(addBtn); ri.appendChild(controls); gdiv.appendChild(ri); }); groupsContainer.appendChild(gdiv); });
    }

    // wire interactions
    applyBtn.addEventListener('click', ()=> renderGroups());
    grpSel.addEventListener('change', ()=> renderGroups()); sortSel.addEventListener('change', ()=> renderGroups()); plannerChk.addEventListener('change', ()=> renderGroups());
    // initial render
    renderGroups();

    // shopping generation handlers
    genBtn.addEventListener('click', ()=>{
      const planner = JSON.parse(localStorage.getItem('planner')||'{}'); const items={}; Object.values(planner).flat().forEach(id=>{ const r=RECIPES.find(rr=>rr.id===id); if(!r) return; r.ingredients.forEach(ing=>{ const key=ing.name.toLowerCase().trim()+'|'+(ing.unit||''); if(!items[key]) items[key]={name:ing.name,qty:0,unit:ing.unit||''}; const cur=items[key]; if((cur.unit==='g'&&ing.unit==='kg')||(cur.unit==='kg'&&ing.unit==='g')){ const aq=cur.unit==='kg'?cur.qty*1000:cur.qty; const bq=ing.unit==='kg'?ing.quantity*1000:ing.quantity; cur.qty = aq + bq; cur.unit='g'; } else if((cur.unit==='ml'&&ing.unit==='l')||(cur.unit==='l'&&ing.unit==='ml')){ const aq=cur.unit==='l'?cur.qty*1000:cur.qty; const bq=ing.unit==='l'?ing.quantity*1000:ing.quantity; cur.qty=aq+bq; cur.unit='ml'; } else if(cur.unit===ing.unit) cur.qty+=ing.quantity; else cur.qty+=ing.quantity; }); }); shopUl.innerHTML=''; Object.values(items).forEach(it=>{ const li=document.createElement('li'); const disp=convertDisplay(it.qty,it.unit); li.textContent = `${disp.value} ${disp.unit} ${it.name}`; shopUl.appendChild(li); }); // attach export payload
      expJson.onclick = ()=>{ const blob=new Blob([JSON.stringify(items,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='shopping.json'; a.click(); URL.revokeObjectURL(url); };
      expCsv.onclick = ()=>{ const rows=Object.values(items).map(i=>({name:i.name,qty:i.qty,unit:i.unit})); const keys=Object.keys(rows[0]||{}); const header=keys.join(','); const lines=rows.map(r=>keys.map(k=>JSON.stringify(r[k]||'')).join(',')); const csv=[header,...lines].join('\n'); const blob=new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='shopping.csv'; a.click(); URL.revokeObjectURL(url); };
    });

    view.appendChild(sec);
  }
  

  // init: restore search, theme, favorites and route
  (function(){
    const s = localStorage.getItem('lastSearch') || '';
    const searchEl = document.getElementById('search');
    if(searchEl) searchEl.value = s;

    // theme
    const theme = localStorage.getItem('theme') || 'light';
    applyTheme(theme);

    // wire favorites button
    const favBtn = document.getElementById('favoritesBtn');
    if(favBtn){
      updateFavCount();
      favBtn.addEventListener('click', ()=>{
        showOnlyFavorites = !showOnlyFavorites;
        favBtn.setAttribute('aria-pressed', String(showOnlyFavorites));
        favBtn.classList.toggle('active', showOnlyFavorites);
        renderCatalog((searchEl && searchEl.value || '').trim().toLowerCase());
      });
    }

    // theme toggle
    const themeToggle = document.getElementById('themeToggle');
    if(themeToggle){ themeToggle.addEventListener('click', ()=>{ const t = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark'; applyTheme(t); }); }

    // add a quick 'Probar API' button next to externalToggle for diagnostics
    try{
      const extLabel = document.querySelector('label[style*="Incluir recetas externas"]') || null;
      const externalControl = document.getElementById('externalToggle');
      if(externalControl){
        const testBtn = document.createElement('button'); testBtn.className='btn'; testBtn.style.marginLeft='6px'; testBtn.textContent='Probar API';
        testBtn.title = 'Prueba si TheMealDB responde (busca Arrabiata)';
        testBtn.addEventListener('click', async ()=>{
          const v = 'Arrabiata'; const view=q('#view');
          // remove previous test panel
          const prev = document.getElementById('tm-test-results'); if(prev) prev.remove();
          const note=document.createElement('div'); note.textContent='Probando conexi√≥n a TheMealDB...'; note.style.margin='8px 0'; view.prepend(note);
          try{
            const res = await fetchExternalMeals(v);
            note.textContent = 'Respuesta: ' + (res && res.length ? (res.length + ' receta(s) encontradas') : '0 resultados');
            if(lastExternalError) note.textContent += ' ‚Äî Error: '+String(lastExternalError).slice(0,200);
            // if results found, render a temporary results panel so user can inspect
            if(res && res.length){
              const panel = document.createElement('section'); panel.id='tm-test-results'; panel.className='section'; const h=document.createElement('h3'); h.textContent='Resultados de prueba (TheMealDB)'; panel.appendChild(h);
              const grid=document.createElement('div'); grid.className='grid'; const showImgs = shouldShowExternalImages();
              res.forEach(r=>{
                const card=document.createElement('article'); card.className='card';
                const posterHtml = (showImgs && r.image) ? `<div class="poster"><img src="${r.image}" alt="${r.title}" loading="lazy"></div>` : `<div class="poster"><strong>${r.title}</strong></div>`;
                card.innerHTML=`${posterHtml}<div class="body"><h4>${r.title} <small style="opacity:.7">(externa)</small></h4><p class="muted">${r.cuisine}</p><p class="muted">${r.description}</p></div>`;
                const actions=document.createElement('div'); actions.className='actions';
                const viewBtn=document.createElement('button'); viewBtn.className='btn'; viewBtn.textContent='Ver detalle'; viewBtn.addEventListener('click', ()=>{
                  // save current catalog state
                  try{ const state={ q: (document.getElementById('search') && document.getElementById('search').value) || '', mode: (document.getElementById('externalMode')||{}).value || 'name' }; sessionStorage.setItem('lastCatalogState', JSON.stringify(state)); }catch(e){}
                  renderExternalDetail(r);
                });
                actions.appendChild(viewBtn); card.appendChild(actions); grid.appendChild(card);
              });
              panel.appendChild(grid);
              const close = document.createElement('button'); close.className='btn'; close.textContent='Cerrar resultados'; close.addEventListener('click', ()=> panel.remove()); panel.appendChild(close);
              // insert after the header
              view.prepend(panel);
            }
          }catch(e){ note.textContent = 'Error al probar API: '+ (e && e.message? e.message: String(e)); }
          setTimeout(()=>{ try{ note.remove(); }catch(e){} }, 6000);
        });
        const exploreBtn = document.createElement('button'); exploreBtn.className='btn'; exploreBtn.style.marginLeft='6px'; exploreBtn.textContent='Explorar TheMealDB';
        exploreBtn.title = 'Explorar varias categor√≠as y obtener m√°s recetas externas';
        exploreBtn.addEventListener('click', async ()=>{ await exploreExternal(); });
        const controlsWrap = document.querySelector('.controls'); if(controlsWrap) controlsWrap.appendChild(exploreBtn);
        // attach the button near the external toggle control
        
      }
    }catch(e){ /* ignore UI insertion errors */ }

    window.addEventListener('hashchange', navigate);
    if(!location.hash) location.hash='#/catalogo';
    navigate();
    // if landing on catalog, apply saved search
    if(location.hash.startsWith('#/catalogo')){
      // attach external toggle listener so the user can switch to external results
      const ext = document.getElementById('externalToggle');
      if(ext){ ext.addEventListener('change', ()=>{ renderCatalog((searchEl && searchEl.value || '').trim().toLowerCase()); }); }
      
        // add control: mostrar im√°genes externas (preference stored en localStorage)
        try{
          const controlsEl = document.querySelector('.controls');
          if(controlsEl){
            const lbl = document.createElement('label'); lbl.style.display='flex'; lbl.style.alignItems='center'; lbl.style.gap='6px'; lbl.style.fontSize='0.9rem';
            const chk = document.createElement('input'); chk.type='checkbox'; chk.id='showExtImages'; chk.checked = localStorage.getItem('showExtImages') === '1';
            chk.addEventListener('change', ()=>{ localStorage.setItem('showExtImages', chk.checked ? '1' : '0'); renderCatalog((searchEl && searchEl.value || '').trim().toLowerCase()); });
            lbl.appendChild(chk); const text = document.createTextNode('Mostrar im√°genes externas'); lbl.appendChild(text); controlsEl.appendChild(lbl);
          }
        }catch(e){/* ignore */}
      renderCatalog(s);
    }
  })();

  </script>
</body>
</html>
